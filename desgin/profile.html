<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>My Profile - Amanoi</title>

   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
   <link rel="stylesheet" href="css/style.css">

   <style>
      .profile-section {
         padding-top: 12rem;
         min-height: 100vh;
         background: var(--sub-color);
      }

      .profile-container {
         max-width: 1200px;
         margin: 0 auto;
         padding: 0 2rem;
      }

      .profile-header {
         background: var(--main-color);
         color: var(--sub-color);
         padding: 3rem;
         border-radius: 0.5rem;
         margin-bottom: 3rem;
         text-align: center;
      }

      .profile-header h1 {
         font-size: 3rem;
         margin-bottom: 1rem;
         font-family: 'Playfair Display', serif;
      }

      .profile-tabs {
         display: flex;
         gap: 1rem;
         margin-bottom: 3rem;
         border-bottom: 2px solid var(--main-color);
      }

      .profile-tab {
         padding: 1.5rem 3rem;
         background: transparent;
         border: none;
         border-bottom: 3px solid transparent;
         color: var(--text-dark);
         font-size: 1.6rem;
         cursor: pointer;
         transition: all 0.3s;
      }

      .profile-tab.active {
         border-bottom-color: var(--main-color);
         color: var(--main-color);
         font-weight: 600;
      }

      .profile-content {
         background: var(--white);
         border: var(--border);
         border-radius: 0.5rem;
         padding: 3rem;
         min-height: 50rem;
      }

      .info-card {
         background: var(--sub-color);
         border: var(--border);
         border-radius: 0.5rem;
         padding: 2rem;
         margin-bottom: 2rem;
      }

      .info-card h3 {
         font-size: 2rem;
         color: var(--main-color);
         margin-bottom: 1.5rem;
         padding-bottom: 1rem;
         border-bottom: 2px solid var(--main-color);
      }

      .info-row {
         display: grid;
         grid-template-columns: 20rem 1fr;
         gap: 2rem;
         padding: 1.5rem 0;
         border-bottom: 1px solid rgba(143, 159, 4, 0.2);
      }

      .info-row:last-child {
         border-bottom: none;
      }

      .info-label {
         font-size: 1.6rem;
         color: var(--text-dark-alt);
         font-weight: 500;
      }

      .info-value {
         font-size: 1.6rem;
         color: var(--text-dark);
         font-weight: 400;
      }

      .booking-card {
         background: var(--sub-color);
         border: var(--border);
         border-radius: 0.5rem;
         padding: 2rem;
         margin-bottom: 2rem;
         transition: all 0.3s;
      }

      .booking-card:hover {
         box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
      }

      .booking-header {
         display: flex;
         justify-content: space-between;
         align-items: center;
         margin-bottom: 1.5rem;
         padding-bottom: 1.5rem;
         border-bottom: 2px solid var(--main-color);
      }

      .booking-ref {
         font-size: 1.8rem;
         font-weight: 600;
         color: var(--main-color);
      }

      .booking-status {
         padding: 0.5rem 1.5rem;
         border-radius: 0.3rem;
         font-size: 1.4rem;
         font-weight: 600;
         text-transform: capitalize;
      }

      .status-confirmed {
         background: var(--main-color);
         color: var(--white);
      }

      .status-cancelled {
         background: #c62828;
         color: var(--white);
      }

      .status-pending {
         background: var(--text-light);
         color: var(--white);
      }

      .status-checked_in {
         background: #1976d2;
         color: var(--white);
      }

      .status-checked_out {
         background: #388e3c;
         color: var(--white);
      }

      .booking-details {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(20rem, 1fr));
         gap: 2rem;
         margin-bottom: 1.5rem;
      }

      .booking-detail-item {
         display: flex;
         flex-direction: column;
         gap: 0.5rem;
      }

      .booking-detail-label {
         font-size: 1.3rem;
         color: var(--text-dark-alt);
      }

      .booking-detail-value {
         font-size: 1.6rem;
         color: var(--text-dark);
         font-weight: 500;
      }

      .booking-price {
         font-size: 2rem;
         color: var(--main-color);
         font-weight: 600;
      }

      .cancel-btn {
         padding: 1rem 2rem;
         background: #c62828;
         color: var(--white);
         border: none;
         border-radius: 0.5rem;
         font-size: 1.4rem;
         cursor: pointer;
         transition: all 0.3s;
         text-transform: uppercase;
         letter-spacing: 0.1rem;
      }

      .cancel-btn:hover {
         background: #b71c1c;
      }

      .cancel-btn:disabled {
         background: #ccc;
         cursor: not-allowed;
      }

      .modal-overlay {
         display: none;
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background: rgba(0, 0, 0, 0.5);
         z-index: 10000;
         align-items: center;
         justify-content: center;
      }

      .modal-overlay.active {
         display: flex;
      }

      .modal {
         background: var(--white);
         border-radius: 0.5rem;
         padding: 3rem;
         max-width: 50rem;
         width: 90%;
         max-height: 90vh;
         overflow-y: auto;
         box-shadow: 0 0.5rem 2rem rgba(0, 0, 0, 0.3);
      }

      .modal-header {
         margin-bottom: 2rem;
      }

      .modal-header h3 {
         font-size: 2.5rem;
         color: var(--text-dark);
         margin-bottom: 0.5rem;
      }

      .modal-body {
         margin-bottom: 2rem;
      }

      .modal-body p {
         font-size: 1.6rem;
         color: var(--text-dark-alt);
         margin-bottom: 1.5rem;
      }

      .modal-body .input {
         width: 100%;
         padding: 1.5rem;
         border: var(--border);
         border-radius: 0.5rem;
         font-size: 1.6rem;
         margin-top: 1rem;
         color: var(--text-dark);
      }

      .modal-footer {
         display: flex;
         gap: 1rem;
         justify-content: flex-end;
      }

      .modal-btn {
         padding: 1rem 2rem;
         border: none;
         border-radius: 0.5rem;
         font-size: 1.6rem;
         cursor: pointer;
         transition: all 0.3s;
      }

      .modal-btn-cancel {
         background: var(--text-light);
         color: var(--white);
      }

      .modal-btn-confirm {
         background: #c62828;
         color: var(--white);
      }

      .modal-btn:hover {
         opacity: 0.9;
      }

      .empty-state {
         text-align: center;
         padding: 5rem 2rem;
         color: var(--text-dark-alt);
      }

      .empty-state i {
         font-size: 5rem;
         margin-bottom: 2rem;
         color: var(--text-light);
      }

      .empty-state p {
         font-size: 1.8rem;
      }
   </style>
</head>
<body>
   <!-- Include API integration - Must load FIRST -->
   <script src="../frontend-integration/api.js"></script>
   <script src="js/auth.js"></script>
   
   <script>
      // Verify API is loaded before page scripts run
      if (typeof AuthAPI === 'undefined' || typeof BookingsAPI === 'undefined') {
         console.error('❌ API scripts not loaded. Waiting for scripts...');
         // Wait a bit for scripts to load
         setTimeout(() => {
            if (typeof AuthAPI === 'undefined' || typeof BookingsAPI === 'undefined') {
               console.error('❌ API scripts still not loaded after delay');
            } else {
               console.log('✅ API scripts loaded after delay');
            }
         }, 500);
      }
   </script>
   
<!-- header section starts  -->

<section class="header">
   <div class="flex">
      <a href="index.html#home" class="logo" style="font-family: 'Playfair Display', serif; font-size: 2.4rem; font-weight: 500;">Amanoi</a>
      <div class="header-actions">
         <a href="index.html#reservation" class="btn btn-primary" style="text-transform: uppercase; letter-spacing: 0.2rem; font-size: 1.2rem; padding: 1rem 2.5rem;">BOOK A ROOM</a>
         <div class="auth-buttons-container"></div>
      </div>
      <div id="menu-btn" class="fas fa-bars"></div>
   </div>
   <nav class="navbar">
      <a href="index.html#home" data-page="home">HOME</a>
      <a href="index.html#locations" data-page="locations">LOCATIONS</a>
      <a href="index.html#reservation" data-page="reservation">BOOK NOW</a>
      <a href="index.html#reviews" data-page="reviews">REVIEWS</a>
      <a href="rooms.html" data-page="rooms">ROOMS</a>
      <a href="index.html#contact" data-page="contact">CONTACT</a>
      <a href="index.html#packages" data-page="packages">PACKAGES</a>
   </nav>
</section>

<!-- header section ends -->

<!-- profile section starts -->

<section class="profile-section" id="profile">
   <div class="profile-container">
      <div class="profile-header">
         <h1><i class="fas fa-user-circle"></i> My Profile</h1>
         <p style="font-size: 1.6rem; opacity: 0.9;">Manage your account and bookings</p>
      </div>

      <div class="profile-tabs">
         <button class="profile-tab active" onclick="switchProfileTab('info')">
            <i class="fas fa-user"></i> Personal Information
         </button>
         <button class="profile-tab" onclick="switchProfileTab('bookings')">
            <i class="fas fa-calendar-check"></i> Booking History
         </button>
      </div>

      <div class="profile-content">
         <!-- Personal Information Tab -->
         <div id="tab-info" class="profile-tab-content">
            <div class="info-card">
               <h3><i class="fas fa-id-card"></i> Basic Information</h3>
               <div id="user-info-content">
                  <div class="loading" style="text-align: center; padding: 3rem; color: var(--text-dark-alt);">Loading user information...</div>
               </div>
            </div>
         </div>

         <!-- Booking History Tab -->
         <div id="tab-bookings" class="profile-tab-content" style="display: none;">
            <h2 style="font-size: 2.5rem; color: var(--text-dark); margin-bottom: 2rem;">My Bookings</h2>
            <div id="bookings-content">
               <div class="loading" style="text-align: center; padding: 3rem; color: var(--text-dark-alt);">Loading bookings...</div>
            </div>
         </div>
      </div>
   </div>
</section>

<!-- Cancellation Modal -->
<div id="cancel-modal" class="modal-overlay">
   <div class="modal">
      <div class="modal-header">
         <h3><i class="fas fa-exclamation-triangle" style="color: #c62828; margin-right: 1rem;"></i>Cancel Booking</h3>
      </div>
      <div class="modal-body">
         <p><strong>Booking Reference:</strong> <span id="cancel-booking-ref"></span></p>
         <p>You are about to cancel this booking. This action cannot be undone.</p>
         <p style="color: #c62828; font-weight: 600;">Please enter your account password to confirm cancellation:</p>
         <input type="password" id="cancel-password" class="input" placeholder="Enter your password" autocomplete="current-password">
         <div id="cancel-error" style="display: none; color: #c62828; margin-top: 1rem; font-size: 1.4rem;"></div>
      </div>
      <div class="modal-footer">
         <button class="modal-btn modal-btn-cancel" onclick="closeCancelModal()">Cancel</button>
         <button class="modal-btn modal-btn-confirm" onclick="confirmCancelBooking()" id="confirm-cancel-btn">
            <i class="fas fa-trash"></i> Confirm Cancellation
         </button>
      </div>
   </div>
</div>

<!-- profile section ends -->

<!-- footer section starts  -->

<section class="footer">
   <div class="box-container">
      <div class="box">
         <h4 style="font-size: 2.4rem; color: var(--white); margin-bottom: 2rem; font-family: 'Playfair Display', serif; font-weight: 400;">Amanoi</h4>
         <a href="#"><i class="fas fa-map-marker-alt"></i> Vinh Hy Village, Vinh Hai Commune, Khanh Hoa Province, Vietnam</a>
         <a href="tel:+842593770777"><i class="fas fa-phone"></i> Tel: +84 931055975</a>
         <a href="tel:+842593535777"><i class="fas fa-phone"></i> For reservations: +84 9310559xxx</a>
         <a href="mailto:amanoi@aman.com"><i class="fas fa-envelope"></i> Email: amanoi@aman.com</a>
      </div>
      <div class="box">
         <h4>More information</h4>
         <a href="index.html#about">Aman Group</a>
         <a href="index.html#locations">Destinations</a>
         <a href="index.html#packages">Experiences</a>
         <a href="index.html#reviews">About Us</a>
         <a href="index.html#contact">Contact Us</a>
      </div>
      <div class="box">
         <h4>Follow Us</h4>
         <a href="#"><i class="fab fa-facebook-f"></i> Facebook</a>
         <a href="#"><i class="fab fa-instagram"></i> Instagram</a>
         <a href="#"><i class="fab fa-twitter"></i> Twitter</a>
         <a href="#"><i class="fab fa-youtube"></i> YouTube</a>
         <a href="#"><i class="fab fa-linkedin"></i> LinkedIn</a>
      </div>
   </div>
   <div class="credit">Copyright 2025, Aman Resorts Ltd</div>
</section>

<!-- footer section ends -->

<script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
<script src="js/script.js"></script>
<script src="js/navigation.js"></script>

<script>
   // Verify API is loaded
   if (typeof AuthAPI === 'undefined' || typeof BookingsAPI === 'undefined') {
      console.error('❌ API scripts not loaded. Please check the path to api.js');
      console.log('Expected path: ../frontend-integration/api.js');
   } else {
      console.log('✅ API scripts loaded successfully');
   }

   // Check authentication on page load
   document.addEventListener('DOMContentLoaded', async function() {
      const token = localStorage.getItem('authToken');
      if (!token) {
         alert('Please login to view your profile.');
         window.location.href = 'auth.html?redirect=profile.html';
         return;
      }

      // Check if APIs are available
      if (typeof AuthAPI === 'undefined') {
         console.error('AuthAPI is not defined');
         document.getElementById('user-info-content').innerHTML = '<div style="color: #c62828; padding: 2rem;">Error: API not loaded. Please refresh the page.</div>';
         return;
      }

      if (typeof BookingsAPI === 'undefined') {
         console.error('BookingsAPI is not defined');
         document.getElementById('bookings-content').innerHTML = '<div style="color: #c62828; padding: 2rem;">Error: API not loaded. Please refresh the page.</div>';
         return;
      }

      try {
         // Load user info and bookings
         await loadUserInfo();
         await loadBookings();
      } catch (error) {
         console.error('Profile load error:', error);
         if (error.message.includes('401') || error.message.includes('token') || error.message.includes('Unauthorized')) {
            alert('Session expired. Please login again.');
            window.location.href = 'auth.html?redirect=profile.html';
         } else {
            console.error('Error details:', error);
         }
      }
   });

   // Switch profile tabs
   function switchProfileTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.profile-tab-content').forEach(content => {
         content.style.display = 'none';
      });

      // Remove active class from all tabs
      document.querySelectorAll('.profile-tab').forEach(tab => {
         tab.classList.remove('active');
      });

      // Show selected tab content
      const selectedTab = document.getElementById(`tab-${tabName}`);
      if (selectedTab) {
         selectedTab.style.display = 'block';
      }

      // Add active class to clicked tab
      event.target.classList.add('active');
   }

   // Load user information
   async function loadUserInfo() {
      const userInfoContent = document.getElementById('user-info-content');
      try {
         const response = await AuthAPI.getCurrentUser();
         if (response.success && response.user) {
            const user = response.user;
            
            userInfoContent.innerHTML = `
               <div class="info-row">
                  <div class="info-label"><i class="fas fa-user"></i> Full Name</div>
                  <div class="info-value">${user.first_name} ${user.last_name}</div>
               </div>
               <div class="info-row">
                  <div class="info-label"><i class="fas fa-envelope"></i> Email</div>
                  <div class="info-value">${user.email}</div>
               </div>
               ${user.phone ? `
               <div class="info-row">
                  <div class="info-label"><i class="fas fa-phone"></i> Phone</div>
                  <div class="info-value">${user.phone}</div>
               </div>
               ` : ''}
               ${user.address ? `
               <div class="info-row">
                  <div class="info-label"><i class="fas fa-map-marker-alt"></i> Address</div>
                  <div class="info-value">${user.address}</div>
               </div>
               ` : ''}
               ${user.city ? `
               <div class="info-row">
                  <div class="info-label"><i class="fas fa-city"></i> City</div>
                  <div class="info-value">${user.city}</div>
               </div>
               ` : ''}
               ${user.country ? `
               <div class="info-row">
                  <div class="info-label"><i class="fas fa-globe"></i> Country</div>
                  <div class="info-value">${user.country}</div>
               </div>
               ` : ''}
               ${user.zip_code ? `
               <div class="info-row">
                  <div class="info-label"><i class="fas fa-mail-bulk"></i> Zip Code</div>
                  <div class="info-value">${user.zip_code}</div>
               </div>
               ` : ''}
               <div class="info-row">
                  <div class="info-label"><i class="fas fa-calendar"></i> Member Since</div>
                  <div class="info-value">${new Date(user.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
               </div>
            `;
         }
      } catch (error) {
         userInfoContent.innerHTML = `<div class="error-message" style="color: #c62828; padding: 2rem;">Error: ${error.message}</div>`;
      }
   }

   // Load bookings
   async function loadBookings() {
      const bookingsContent = document.getElementById('bookings-content');
      
      // Check if API is available
      if (typeof BookingsAPI === 'undefined') {
         bookingsContent.innerHTML = '<div style="color: #c62828; padding: 2rem;">Error: BookingsAPI is not loaded. Please refresh the page.</div>';
         return;
      }

      try {
         console.log('Loading bookings...');
         const response = await BookingsAPI.getMyBookings();
         console.log('Bookings response:', response);
         console.log('Response type:', typeof response);
         console.log('Response keys:', response ? Object.keys(response) : 'null');
         
         if (!response) {
            bookingsContent.innerHTML = '<div style="color: #c62828; padding: 2rem;">Error: No response from server</div>';
            return;
         }
         
         if (response && response.success) {
            // Check if bookings array exists and has items
            const bookings = response.bookings || response.data || [];
            console.log('Bookings array:', bookings);
            console.log('Bookings count:', bookings.length);
            
            if (!Array.isArray(bookings)) {
               console.error('Bookings is not an array:', bookings);
               bookingsContent.innerHTML = '<div style="color: #c62828; padding: 2rem;">Error: Invalid bookings data format</div>';
               return;
            }
            
            if (bookings.length === 0) {
               bookingsContent.innerHTML = `
                  <div class="empty-state">
                     <i class="fas fa-calendar-times"></i>
                     <p>You don't have any bookings yet.</p>
                     <a href="rooms.html" class="btn" style="margin-top: 2rem;">Book a Room</a>
                  </div>
               `;
               return;
            }

            const defaultCheckInTime = '3:00 PM';
            
            bookingsContent.innerHTML = bookings.map(booking => {
               console.log('Processing booking:', booking);
               const checkInDate = new Date(booking.check_in);
               const checkOutDate = new Date(booking.check_out);
               const canCancel = booking.booking_status !== 'cancelled' && 
                               booking.booking_status !== 'checked_in' && 
                               booking.booking_status !== 'checked_out';
               
               const statusClass = `status-${booking.booking_status}`;
               
               return `
                  <div class="booking-card">
                     <div class="booking-header">
                        <div class="booking-ref">${booking.booking_reference}</div>
                        <span class="booking-status ${statusClass}">${booking.booking_status}</span>
                     </div>
                     
                     <div class="booking-details">
                        <div class="booking-detail-item">
                           <span class="booking-detail-label">Room</span>
                           <span class="booking-detail-value">${booking.room_name || 'N/A'}</span>
                        </div>
                        <div class="booking-detail-item">
                           <span class="booking-detail-label">Check-in</span>
                           <span class="booking-detail-value">${checkInDate.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}<br><small style="color: var(--text-dark-alt);">${defaultCheckInTime}</small></span>
                        </div>
                        <div class="booking-detail-item">
                           <span class="booking-detail-label">Check-out</span>
                           <span class="booking-detail-value">${checkOutDate.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}</span>
                        </div>
                        <div class="booking-detail-item">
                           <span class="booking-detail-label">Guests</span>
                           <span class="booking-detail-value">${booking.adults} Adult(s), ${booking.children || 0} Child(ren)</span>
                        </div>
                        <div class="booking-detail-item">
                           <span class="booking-detail-label">Nights</span>
                           <span class="booking-detail-value">${booking.nights || 1}</span>
                        </div>
                        <div class="booking-detail-item">
                           <span class="booking-detail-label">Total Price</span>
                           <span class="booking-detail-value booking-price">$${parseFloat(booking.total_price || 0).toFixed(2)}</span>
                        </div>
                     </div>
                     
                     ${canCancel ? `
                        <div style="text-align: right; margin-top: 1.5rem;">
                           <button class="cancel-btn" onclick="openCancelModal(${booking.id}, '${booking.booking_reference}')">
                              <i class="fas fa-times"></i> Cancel Booking
                           </button>
                        </div>
                     ` : ''}
                  </div>
               `;
            }).join('');
         } else {
            bookingsContent.innerHTML = `<div class="error-message" style="color: #c62828; padding: 2rem;">Error: ${response?.message || 'Failed to load bookings'}</div>`;
         }
      } catch (error) {
         console.error('Load bookings error:', error);
         let errorMessage = error.message || 'Failed to load bookings';
         
         if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
            errorMessage = 'Cannot connect to backend server. Please make sure the server is running on http://localhost:3000';
         }
         
         bookingsContent.innerHTML = `<div class="error-message" style="color: #c62828; padding: 2rem;">
            <strong>Error loading bookings:</strong><br>
            ${errorMessage}<br><br>
            <button onclick="location.reload()" class="btn" style="margin-top: 1rem;">Retry</button>
         </div>`;
      }
   }

   // Cancel booking modal
   let currentCancelBookingId = null;

   function openCancelModal(bookingId, bookingRef) {
      currentCancelBookingId = bookingId;
      document.getElementById('cancel-booking-ref').textContent = bookingRef;
      document.getElementById('cancel-password').value = '';
      document.getElementById('cancel-error').style.display = 'none';
      document.getElementById('cancel-modal').classList.add('active');
      document.getElementById('cancel-password').focus();
   }

   function closeCancelModal() {
      document.getElementById('cancel-modal').classList.remove('active');
      currentCancelBookingId = null;
      document.getElementById('cancel-password').value = '';
      document.getElementById('cancel-error').style.display = 'none';
   }

   async function confirmCancelBooking() {
      const password = document.getElementById('cancel-password').value;
      const errorDiv = document.getElementById('cancel-error');
      const confirmBtn = document.getElementById('confirm-cancel-btn');

      if (!password) {
         errorDiv.textContent = 'Password is required';
         errorDiv.style.display = 'block';
         return;
      }

      if (!currentCancelBookingId) {
         errorDiv.textContent = 'No booking selected';
         errorDiv.style.display = 'block';
         return;
      }

      // Disable button
      confirmBtn.disabled = true;
      confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
      errorDiv.style.display = 'none';

      try {
         const result = await BookingsAPI.cancel(currentCancelBookingId, password);
         if (result && result.success) {
            alert('Booking cancelled successfully!');
            closeCancelModal();
            // Reload bookings
            await loadBookings();
         }
      } catch (error) {
         errorDiv.textContent = error.message || 'Failed to cancel booking';
         errorDiv.style.display = 'block';
      } finally {
         confirmBtn.disabled = false;
         confirmBtn.innerHTML = '<i class="fas fa-trash"></i> Confirm Cancellation';
      }
   }

   // Close modal on overlay click
   document.getElementById('cancel-modal')?.addEventListener('click', function(e) {
      if (e.target === this) {
         closeCancelModal();
      }
   });

   // Close modal on Escape key
   document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
         closeCancelModal();
      }
   });
</script>

</body>
</html>

